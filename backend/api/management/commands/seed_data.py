"""
Management command to seed initial data for the application
"""
from django.core.management.base import BaseCommand
from api.models import CBTContent, CrisisResource


class Command(BaseCommand):
    help = 'Seeds initial CBT content and crisis resources'

    def handle(self, *args, **options):
        # Create CBT Content - Programs (Practices) with Lessons
        programs_data = [
            {
                'title': 'Перезагрузка: меняем отношение к стрессу',
                'category': 'conditions',
                'content': '''Программа "Перезагрузка" поможет вам изменить отношение к стрессу и научиться управлять им более эффективно. 

Стресс - это естественная реакция организма на вызовы, но когда он становится хроническим, это может негативно влиять на ваше здоровье и благополучие. В этой программе вы узнаете, как:

• Распознавать источники стресса в вашей жизни
• Изменить негативные мысли о стрессе
• Развить навыки управления стрессом
• Создать личную стратегию преодоления стресса

Программа состоит из нескольких уроков, которые помогут вам постепенно изменить свое отношение к стрессу и научиться использовать его как источник энергии для роста.''',
                'order': 1,
                'lessons': [
                    {
                        'title': 'Урок 1: Понимание стресса и его влияния',
                        'category': 'conditions',
                        'content': '''Первый урок программы "Перезагрузка" посвящен пониманию природы стресса.

Что такое стресс?
Стресс - это физиологическая и психологическая реакция на ситуации, которые мы воспринимаем как угрожающие или требующие больше ресурсов, чем у нас есть.

Типы стресса:
1. Острый стресс - кратковременная реакция на конкретную ситуацию
2. Хронический стресс - длительное воздействие стрессовых факторов
3. Эустресс - положительный стресс, который мотивирует и помогает расти

Как стресс влияет на нас:
• Физически: головные боли, усталость, проблемы со сном
• Эмоционально: раздражительность, тревога, подавленность
• Когнитивно: трудности с концентрацией, забывчивость
• Поведенчески: изменения в аппетите, социальная изоляция

Практическое задание:
В течение недели ведите дневник стресса. Записывайте:
- Что вызвало стресс?
- Как вы отреагировали физически и эмоционально?
- Что помогло справиться?

Это поможет вам лучше понять свои паттерны реакции на стресс.''',
                        'order': 1,
                    },
                    {
                        'title': 'Урок 2: Когнитивная переоценка стресса',
                        'category': 'conditions',
                        'content': '''Второй урок научит вас изменять свои мысли о стрессе.

Ключевая идея: Стресс - это не враг, а сигнал о том, что что-то важно для вас.

Техника когнитивной переоценки:
1. Распознайте негативные мысли о стрессе
   Пример: "Стресс разрушает меня"
   
2. Оспорьте эту мысль
   Вопросы для размышления:
   - Действительно ли стресс всегда вреден?
   - Может ли стресс быть полезным?
   - Что говорит наука о стрессе?
   
3. Создайте новую, более сбалансированную мысль
   Пример: "Стресс - это моя реакция на важные события. Я могу научиться управлять им."

Исследования показывают:
Люди, которые воспринимают стресс как полезный, имеют лучшие показатели здоровья и производительности. Изменение отношения к стрессу может изменить его физическое воздействие на организм.

Практическое упражнение:
Выберите одну стрессовую ситуацию из вашего дневника. Примените технику когнитивной переоценки:
- Запишите негативную мысль
- Оспорьте её
- Создайте новую, более полезную мысль
- Обратите внимание, как изменились ваши чувства''',
                        'order': 2,
                    },
                    {
                        'title': 'Урок 3: Практические техники управления стрессом',
                        'category': 'conditions',
                        'content': '''Третий урок предоставит вам конкретные инструменты для управления стрессом.

Техника 1: Дыхательные упражнения (4-7-8)
• Вдохните через нос на 4 счета
• Задержите дыхание на 7 счетов
• Выдохните через рот на 8 счетов
• Повторите 4-8 раз

Техника 2: Прогрессивная мышечная релаксация
Напрягите и расслабьте мышцы по порядку:
1. Стопы и икры (5 секунд напряжение, 10 секунд расслабление)
2. Бедра и ягодицы
3. Руки и предплечья
4. Плечи и шея
5. Лицо и челюсть

Техника 3: Временная перспектива
Когда чувствуете стресс, спросите себя:
- Будет ли это важно через неделю?
- Через месяц?
- Через год?

Это помогает уменьшить интенсивность реакции на временные стрессоры.

Техника 4: Планирование и приоритизация
• Составьте список задач
• Определите приоритеты (важно/срочно)
• Разбейте большие задачи на маленькие шаги
• Делегируйте, когда возможно

Создание личного плана:
1. Выберите 2-3 техники, которые вам подходят
2. Практикуйте их ежедневно в течение недели
3. Отмечайте, какие техники наиболее эффективны для вас
4. Адаптируйте техники под свои потребности

Помните: Управление стрессом - это навык, который развивается с практикой.''',
                        'order': 3,
                    },
                ],
            },
            {
                'title': 'Тревога, стоп! Возьми под контроль свои мысли',
                'category': 'conditions',
                'content': '''Программа "Тревога, стоп!" разработана для тех, кто хочет научиться управлять тревожными мыслями и вернуть контроль над своей жизнью.

Тревога - это нормальная эмоция, но когда она становится постоянной и интенсивной, она может мешать повседневной жизни. Эта программа поможет вам:

• Понять механизмы тревоги
• Распознать триггеры тревожных мыслей
• Научиться останавливать цикл тревоги
• Развить навыки управления тревожными состояниями
• Создать личный набор инструментов для работы с тревогой

Программа основана на принципах когнитивно-поведенческой терапии и включает практические упражнения, которые вы можете применять в реальной жизни.''',
                'order': 2,
                'lessons': [
                    {
                        'title': 'Урок 1: Понимание тревоги и её циклов',
                        'category': 'conditions',
                        'content': '''Первый урок поможет вам понять, что такое тревога и как она работает.

Что такое тревога?
Тревога - это реакция "бей, беги или замри" на воспринимаемую угрозу. Это нормальная и полезная реакция, которая помогает нам выживать.

Когда тревога становится проблемой:
• Когда она возникает без реальной угрозы
• Когда она длится слишком долго
• Когда она мешает повседневной деятельности
• Когда она вызывает физические симптомы

Цикл тревоги:
1. Триггер (ситуация, мысль, ощущение)
2. Автоматическая мысль ("Что-то плохое случится")
3. Физическая реакция (учащенное сердцебиение, напряжение)
4. Поведенческая реакция (избегание, проверка)
5. Усиление тревоги (цикл повторяется)

Типы тревожных мыслей:
• Катастрофизация: "Это будет ужасно"
• Чтение мыслей: "Они думают, что я неудачник"
• Предсказание будущего: "Я точно провалюсь"
• Долженствования: "Я должен быть идеальным"

Практическое задание:
Ведите дневник тревоги в течение недели:
- Когда возникает тревога?
- Какие мысли приходят в голову?
- Что происходит в теле?
- Что вы делаете в ответ?
- Что помогает снизить тревогу?

Это поможет вам увидеть свои паттерны тревоги.''',
                        'order': 1,
                    },
                    {
                        'title': 'Урок 2: Остановка тревожных мыслей',
                        'category': 'conditions',
                        'content': '''Второй урок научит вас останавливать тревожные мысли до того, как они разовьются в полномасштабную тревогу.

Техника 1: Остановка мысли
Когда замечаете тревожную мысль:
1. Скажите себе "СТОП!" (можно мысленно или вслух)
2. Сделайте глубокий вдох
3. Переключите внимание на что-то конкретное (5 вещей, которые видите, 4 звука, 3 ощущения)
4. Вернитесь к текущему моменту

Техника 2: Проверка реальности
Задайте себе вопросы:
• Какие есть доказательства, что моя мысль верна?
• Какие есть доказательства против?
• Что бы я сказал другу в такой ситуации?
• Какова реальная вероятность худшего исхода?
• Что самое вероятное произойдет?

Техника 3: Отсрочка беспокойства
Вместо того чтобы беспокоиться постоянно:
1. Выделите 15-20 минут в день для "времени беспокойства"
2. Когда тревожная мысль приходит в другое время, скажите: "Я подумаю об этом в свое время беспокойства"
3. Запишите мысль и отложите её
4. В назначенное время разберите эти мысли

Техника 4: Метод 5-4-3-2-1
Когда чувствуете нарастающую тревогу:
• Назовите 5 вещей, которые видите
• Назовите 4 вещи, к которым можете прикоснуться
• Назовите 3 звука, которые слышите
• Назовите 2 запаха
• Назовите 1 вкус

Это помогает вернуться в настоящий момент.

Практическое упражнение:
Выберите одну тревожную мысль из вашего дневника. Примените технику проверки реальности. Запишите:
- Исходная мысль
- Доказательства за
- Доказательства против
- Более сбалансированная мысль
- Как изменился уровень тревоги (0-10)''',
                        'order': 2,
                    },
                    {
                        'title': 'Урок 3: Изменение тревожных убеждений',
                        'category': 'conditions',
                        'content': '''Третий урок поможет вам изменить глубинные убеждения, которые поддерживают тревогу.

Распознавание тревожных убеждений:
• "Я не справлюсь"
• "Люди будут судить меня"
• "Если я не контролирую всё, случится что-то плохое"
• "Тревога опасна и вредна"
• "Я должен быть идеальным"

Техника: Когнитивная реструктуризация
Шаг 1: Определите ситуацию
   Пример: "Завтра у меня презентация"
   
Шаг 2: Определите автоматическую мысль
   "Я провалюсь, все увидят, что я некомпетентен"
   
Шаг 3: Определите эмоции и интенсивность
   Тревога 8/10, страх 7/10
   
Шаг 4: Оспорьте мысль
   - Какие доказательства?
   - Были ли успешные презентации раньше?
   - Что самое вероятное произойдет?
   - Что бы сказал друг?
   
Шаг 5: Создайте сбалансированную мысль
   "Я подготовился, у меня есть опыт. Даже если что-то пойдет не так, это не катастрофа. Я справлюсь."

Шаг 6: Проверьте эмоции
   Тревога 4/10, уверенность 6/10

Работа с убеждением "Тревога опасна":
• Тревога - это просто эмоция, она не может причинить физический вред
• Симптомы тревоги неприятны, но не опасны
• Тревога проходит сама по себе
• Я переживал тревогу раньше и справился

Практическое упражнение:
Создайте таблицу для работы с тревожными мыслями:
| Ситуация | Автоматическая мысль | Эмоции (0-10) | Доказательства за | Доказательства против | Сбалансированная мысль | Новые эмоции (0-10) |

Заполняйте эту таблицу каждый раз, когда замечаете тревожную мысль. Со временем вы заметите, что сбалансированные мысли приходят автоматически.''',
                        'order': 3,
                    },
                ],
            },
            {
                'title': 'Сила спокойствия: как управлять гневом',
                'category': 'conditions',
                'content': '''Программа "Сила спокойствия" поможет вам научиться управлять гневом и развить навыки эмоциональной регуляции.

Гнев - это нормальная и полезная эмоция, которая сигнализирует о том, что наши границы нарушены или наши потребности не удовлетворены. Однако неконтролируемый гнев может разрушать отношения и вредить здоровью.

В этой программе вы узнаете:
• Как понять природу гнева и его функции
• Как распознать ранние признаки гнева
• Техники для управления гневом в момент его возникновения
• Стратегии для предотвращения вспышек гнева
• Как выражать гнев конструктивно
• Как восстанавливаться после эпизодов гнева

Программа включает практические упражнения и техники, которые вы сможете применять в реальных ситуациях.''',
                'order': 3,
                'lessons': [
                    {
                        'title': 'Урок 1: Понимание гнева и его триггеров',
                        'category': 'conditions',
                        'content': '''Первый урок поможет вам понять природу гнева и научиться распознавать его триггеры.

Что такое гнев?
Гнев - это эмоциональная реакция на воспринимаемую несправедливость, угрозу или фрустрацию. Это нормальная эмоция, которая может быть полезной, когда выражается конструктивно.

Функции гнева:
• Сигнализирует о нарушении границ
• Мобилизует энергию для защиты
• Помогает выразить недовольство
• Мотивирует к изменениям

Когда гнев становится проблемой:
• Когда он возникает слишком часто или интенсивно
• Когда он длится слишком долго
• Когда он приводит к агрессивному поведению
• Когда он мешает отношениям и работе
• Когда он вызывает проблемы со здоровьем

Триггеры гнева:
1. Внешние триггеры:
   - Критика или осуждение
   - Несправедливое обращение
   - Фрустрация (пробки, очереди)
   - Нарушение личных границ
   
2. Внутренние триггеры:
   - Усталость или голод
   - Стресс или тревога
   - Боль или дискомфорт
   - Воспоминания о прошлых обидах
   
3. Когнитивные триггеры:
   - Мысли о несправедливости
   - Интерпретации намерений других
   - "Долженствования" ("Они должны были...")
   - Катастрофизация

Физические признаки гнева:
• Напряжение мышц
• Учащенное сердцебиение
• Покраснение лица
• Сжатие кулаков
• Стиснутые зубы
• Повышение температуры тела

Практическое задание:
Ведите дневник гнева в течение недели:
- Что вызвало гнев? (ситуация, мысль, ощущение)
- Какие физические признаки вы заметили?
- Какие мысли пришли в голову?
- Как вы отреагировали?
- Что помогло успокоиться?
- Каковы были последствия?

Это поможет вам выявить свои паттерны гнева.''',
                        'order': 1,
                    },
                    {
                        'title': 'Урок 2: Техники управления гневом в момент',
                        'category': 'conditions',
                        'content': '''Второй урок предоставит вам конкретные техники для управления гневом, когда вы чувствуете, что он нарастает.

Техника 1: Тайм-аут
Когда чувствуете, что гнев нарастает:
1. Скажите: "Мне нужен перерыв"
2. Уйдите из ситуации (если возможно)
3. Подождите минимум 20 минут
4. Используйте это время для успокоения
5. Вернитесь к обсуждению, когда будете готовы

Правило: Не принимайте важных решений и не ведите серьезных разговоров в состоянии гнева.

Техника 2: Дыхательные упражнения
• Вдохните через нос на 4 счета
• Задержите дыхание на 4 счета
• Выдохните через рот на 6-8 счетов
• Повторите 5-10 раз

Это активирует парасимпатическую нервную систему и помогает успокоиться.

Техника 3: Прогрессивная мышечная релаксация
Напрягите и расслабьте мышцы:
1. Сожмите кулаки на 5 секунд, затем расслабьте
2. Напрягите плечи, затем расслабьте
3. Напрягите лицо, затем расслабьте
4. Напрягите все тело, затем полностью расслабьте

Техника 4: Отсчет
• Сосчитайте от 10 до 1 медленно
• Или сосчитайте предметы вокруг себя
• Это помогает переключить внимание

Техника 5: Изменение перспективы
Задайте себе вопросы:
• Будет ли это важно через час?
• Через день?
• Через неделю?
• Что самое вероятное произойдет?
• Как я хочу, чтобы это разрешилось?

Техника 6: Физическая активность
• Быстрая ходьба
• Бег на месте
• Отжимания
• Растяжка
Физическая активность помогает сжечь адреналин и успокоиться.

Создание личного плана "СТОП":
S - Остановитесь (Stop)
T - Дышите (Take a breath)
O - Наблюдайте (Observe) - что происходит?
P - Продолжайте с намерением (Proceed with intention)

Практическое упражнение:
Выберите 2-3 техники, которые вам подходят. Практикуйте их ежедневно, даже когда не злитесь. Это поможет вам применять их автоматически в момент гнева.''',
                        'order': 2,
                    },
                    {
                        'title': 'Урок 3: Конструктивное выражение гнева',
                        'category': 'conditions',
                        'content': '''Третий урок научит вас выражать гнев конструктивно, не причиняя вреда себе и другим.

Почему важно выражать гнев?
Подавленный гнев может привести к:
• Депрессии
• Тревоге
• Проблемам со здоровьем
• Взрывным вспышкам позже

Конструктивное выражение гнева:
1. Признайте свой гнев
   "Я чувствую гнев, и это нормально"
   
2. Определите причину
   "Я злюсь, потому что..."
   
3. Выразите потребность
   "Мне нужно..."
   
4. Предложите решение
   "Можем ли мы..."

Формула "Я-высказываний":
"Я чувствую [эмоция], когда [ситуация], потому что [потребность]. Я хотел бы [желаемое поведение]."

Пример:
❌ "Ты всегда опаздываешь! Ты не уважаешь мое время!"
✅ "Я чувствую раздражение, когда ты опаздываешь, потому что мне важно быть пунктуальным. Я хотел бы, чтобы мы договорились о времени и придерживались его."

Работа с мыслями, усиливающими гнев:
• "Они сделали это специально" → "Возможно, у них были другие причины"
• "Они должны были знать" → "Они не могут читать мои мысли"
• "Это несправедливо!" → "Что я могу сделать конструктивно?"

Техника: Когнитивная реструктуризация для гнева
1. Определите ситуацию
2. Определите мысль, вызывающую гнев
3. Оспорьте мысль:
   - Есть ли другие объяснения?
   - Что самое вероятное?
   - Помогает ли эта мысль решить проблему?
4. Создайте более сбалансированную мысль
5. Выразите потребность конструктивно

Практическое упражнение:
Выберите одну ситуацию из вашего дневника гнева. Примените формулу "Я-высказываний":
- Опишите ситуацию
- Определите свою эмоцию
- Определите свою потребность
- Сформулируйте конструктивное "Я-высказывание"
- Предложите решение

Помните: Цель - не подавить гнев, а выразить его так, чтобы это привело к пониманию и решению проблемы.''',
                        'order': 3,
                    },
                ],
            },
        ]

        # Delete all programs that are not in the current list
        current_program_titles = {program['title'] for program in programs_data}
        CBTContent.objects.filter(parent__isnull=True).exclude(title__in=current_program_titles).delete()
        
        # Delete all lessons that don't belong to current programs
        CBTContent.objects.filter(parent__isnull=False).exclude(parent__title__in=current_program_titles).delete()
        
        # Create programs and their lessons
        for program_data in programs_data:
            lessons_data = program_data.pop('lessons', [])
            
            # Create the program (practice) - ensure parent is None
            program_data_copy = program_data.copy()
            program_data_copy['parent'] = None
            
            # Create or update the program (practice)
            program, created = CBTContent.objects.get_or_create(
                title=program_data['title'],
                defaults=program_data_copy
            )
            
            # Update program if it already exists
            if not created:
                for key, value in program_data_copy.items():
                    setattr(program, key, value)
                program.save()
            
            # Delete old lessons that don't match current lessons
            existing_lesson_titles = {lesson['title'] for lesson in lessons_data}
            program.lessons.exclude(title__in=existing_lesson_titles).delete()
            
            # Create or update lessons for this program
            for lesson_data in lessons_data:
                lesson, lesson_created = CBTContent.objects.get_or_create(
                    title=lesson_data['title'],
                    defaults={
                        **lesson_data,
                        'parent': program,
                    }
                )
                
                # Update lesson if it already exists but parent is wrong
                if not lesson_created and lesson.parent != program:
                    lesson.parent = program
                    for key, value in lesson_data.items():
                        if key != 'title':  # Don't update title
                            setattr(lesson, key, value)
                    lesson.save()
                elif not lesson_created:
                    # Update other fields if lesson exists
                    for key, value in lesson_data.items():
                        if key != 'title':  # Don't update title
                            setattr(lesson, key, value)
                    lesson.save()

        self.stdout.write(self.style.SUCCESS('Created CBT programs and lessons'))

        # Create Crisis Resources
        crisis_resources = [
            {
                'title': 'National Suicide Prevention Lifeline',
                'description': '24/7 free and confidential support for people in distress, prevention and crisis resources.',
                'phone_number': '988',
                'website_url': 'https://988lifeline.org',
                'is_emergency': True,
                'order': 1,
            },
            {
                'title': 'Crisis Text Line',
                'description': 'Free 24/7 crisis support via text message.',
                'phone_number': 'Text HOME to 741741',
                'website_url': 'https://www.crisistextline.org',
                'is_emergency': True,
                'order': 2,
            },
            {
                'title': 'Mental Health America',
                'description': 'Resources and information about mental health conditions and support.',
                'website_url': 'https://www.mhanational.org',
                'is_emergency': False,
                'order': 1,
            },
            {
                'title': 'National Alliance on Mental Illness (NAMI)',
                'description': 'Education, support, and advocacy for people affected by mental illness.',
                'website_url': 'https://www.nami.org',
                'is_emergency': False,
                'order': 2,
            },
        ]

        for resource_data in crisis_resources:
            CrisisResource.objects.get_or_create(
                title=resource_data['title'],
                defaults=resource_data
            )

        self.stdout.write(self.style.SUCCESS('Created crisis resources'))
        self.stdout.write(self.style.SUCCESS('Data seeding completed!'))
